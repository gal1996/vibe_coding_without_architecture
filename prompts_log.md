# プロンプト記録ログ

## 概要
このファイルは、Vibe-Coding実験（グループ A: No-Arch）で投げられたすべてのプロンプトを時系列で記録します。

## 記録フォーマット
各プロンプトは以下の形式で記録されます：
- **タスクID**: TASK_XXX
- **日時**: YYYY-MM-DD HH:MM:SS
- **プロンプト内容**: 実際のプロンプトテキスト
- **開始時刻**: 作業開始時刻
- **完了時刻**: 作業完了時刻
- **実行時間**: T_exec（分）

---

## プロンプト履歴

### TASK_000: 実験環境準備
- **日時**: 2025-11-16 (初期セットアップ)
- **プロンプト内容**: 「依頼の目的：Vibe-Codingの有効性検証プロジェクト（実験記録準備）」
- **開始時刻**: -
- **完了時刻**: -
- **実行時間**: -
- **備考**: 実験記録ファイルの準備

---

---
Task_ID: TASK_001
Timestamp: 2025-11-16 12:37:06
---
# プロジェクト名: ECサイトバックエンドAPI実装

## 1. 概要
ユーザー、商品、および注文を管理するバックエンドAPIシステムを実装する。

## 2. エンティティ仕様
以下のデータ構造を定義し、システム内で使用する。

| エンティティ | 必須フィールド |
| :--- | :--- |
| **Product** (商品) | ID, 名前, 価格 (整数), 在庫数 (整数, 0以上), カテゴリ (文字列) |
| **User** (ユーザー) | ID, ユーザー名 (ユニーク), 認証情報（例：パスワードハッシュ）, 管理者フラグ (boolean) |
| **Order** (注文) | ID, ユーザーID, 注文明細 (商品IDと数量のリスト), 合計金額, ステータス |

## 3. 機能要件 (API)
以下の主要な機能を実現するためのAPIを実装すること。

1.  **商品管理:** 商品の作成、一覧表示、詳細表示の機能。
2.  **ユーザー管理:** ユーザーの登録、認証（ログイン）の機能。
3.  **注文処理:** ユーザーが商品を確定注文する機能。

## 4. ビジネスロジックと制約
特に以下の重要な制約とロジックを厳守すること。

1.  **アトミックな注文処理:** 注文の確定時、要求された商品について以下の処理を**同時に**実行すること。
    * 在庫チェック: 在庫が不足している場合は注文を拒否する。
    * 在庫削減: 注文が成功した場合、該当商品の在庫数を注文数分だけ正確に減少させること。
2.  **商品一覧のフィルタリング:** 商品一覧を取得する際、カテゴリ名に基づいてフィルタリングできること。
3.  **管理者認可:** 新規商品を作成する機能は、**管理者ユーザー**のみが実行できること。

---

## 5. 実験タスク

### タスク A: 最小実装
上記の仕様を満たすコードを、**最も迅速かつ少ないファイル数**で実装し、その結果のファイル構成とコードを提示してください。

### タスク B: アーキテクチャ分離実装
上記の仕様を満たすコードを、**クリーンアーキテクチャ**の原則に基づき、厳密なレイヤー分離を適用して実装し、その結果のファイル構成とコードを提示してください。
---

### TASK_MT1: 消費税と送料ロジックの実装
- **タスクID**: TASK_MT1
- **日時**: 2025-11-16 18:45:00
- **プロンプト内容**:
```
# MT-1 機能追加タスク：消費税と送料ロジックの実装

このタスクは、既存のECサイトバックエンドAPIに対する仕様変更（保守性検証）です。あなたは、初期実装されたコードベースに以下のロジックを追加する必要があります。

## 1. 共通の仕様変更内容

すべての注文処理に対し、以下のビジネスロジックを追加してください。

1.  **消費税 (10%) の適用:**
    * 注文の合計金額（`total_amount`）を計算する際、商品価格の合計（税抜）に一律で **10% の消費税**を加算すること。
2.  **送料無料条件の追加:**
    * 注文の合計金額（税抜）が **5,000円**以上の場合は送料を**無料**とし、5,000円未満の場合は一律 **500円**の送料を加算すること。
3.  **エンティティの更新:**
    * `Order` エンティティには、最終的な合計金額（送料・税込）を保持する既存のフィールドに加え、新たに **`shipping_fee`（送料額）**フィールドを追加すること。
```
- **開始時刻**: 18:45:00
- **完了時刻**: 19:00:00
- **実行時間**: 15分

---

### TASK_MT3: 外部決済ゲートウェイ連携
- **タスクID**: TASK_MT3
- **日時**: 2026-01-04 11:57:34
- **プロンプト内容**:
```
🚀 MT-3 仕様書：外部決済ゲートウェイの連携
1. 概要
現在の注文フローを拡張し、外部の決済サービスとの連携機能を追加する。決済が承認された場合のみ、在庫の減算および注文の確定を行うように変更すること。

2. 追加機能：決済確認ステップ
注文確定処理（POST /orders）のプロセス内に、以下のロジックを組み込むこと。

外部決済呼び出し（シミュレーション）:
- 注文の「最終合計金額」をパラメータとして受け取り、決済の成否を返す外部通信処理をシミュレートすること。
- 実装: 外部APIの実体はないため、ランダム（例：90%で成功）または特定のロジックで Success / Failure を返すダミーの関数またはクラスを内部に用意して呼び出す。

ステータス制御:
- 決済成功時: 在庫を減算し、注文ステータスを Completed（完了）として保存する。
- 決済失敗時: 在庫は減らさず、注文ステータスを PaymentFailed（決済失敗）等で保存し、ユーザーには適切なエラーレスポンスを返すこと。

3. ビジネスルールと制約
- 実行順序の厳守: 在庫を減らした後に決済が失敗して、在庫が戻らないといった不整合を避けるため、適切な順序（またはトランザクション管理）で実装すること。
- 拡張性: 将来的に本物の決済プロバイダ（Stripe等）へ差し替えられるよう、決済ロジックの独立性を考慮すること。
```
- **開始時刻**: 11:57:34
- **完了時刻**: 12:11:47
- **実行時間**: 14分
- **備考**:
  - 決済機能の実装自体は一発で正常動作
  - 既存実装の2つのバグを発見・修正：
    1. `generateToken()`関数でトークンが重複する問題（タイムスタンプの精度不足）
    2. `TestMainHandler`テストケースの期待値の誤り（404 vs 405）
  - これらのバグは過去の実装（TASK_001）に起因するもの

---

### TASK_MT4: 複数拠点での在庫管理（マルチワイヤハウス）への移行
- **タスクID**: TASK_MT4
- **日時**: 2026-01-04 13:42:44
- **プロンプト内容**:
```
🚀 MT-4 仕様書：複数拠点での在庫管理（マルチワイヤハウス）への移行
1. 概要
事業拡大に伴い、これまで商品ごとに1つだった在庫数（単一の数値）を、複数の拠点（倉庫）ごとに切り分けて管理するようにシステムを拡張します。

2. データモデルの変更
在庫の持ち方を以下のように変更してください。

Productエンティティの変更:
- 既存の stock_quantity フィールドを削除してください。

Warehouse（倉庫）エンティティの導入:
- フィールド: id (UUID/Int), name (文字列)

Stock（在庫明細）の導入:
- 商品と倉庫を紐づけ、拠点ごとの quantity（在庫数）を保持します。
- 1つの商品は複数の倉庫に在庫を持つことができます。

3. 機能要件の変更
3.1. 商品取得 API (GET /products/{id})
- レスポンスに、各倉庫ごとの在庫内訳（倉庫名、在庫数）を含めるように拡張してください。
- 全倉庫の合計在庫数も併せて表示してください。

3.2. 注文確定 API (POST /orders)
在庫の引き当てロジックを以下のように変更してください。
- 在庫確認: 対象商品の「全倉庫の合計在庫数」が注文数以上あるかを確認します。
- 引き当てロジック: 合計在庫が十分な場合、在庫が存在する倉庫から順に注文数を差し引いてください。
  例：注文数5に対し、倉庫Aに3個、倉庫Bに10個ある場合、倉庫Aから3個、倉庫Bから2個差し引く。
- 不整合の防止: 合計在庫が不足している場合は、これまで通り注文を拒否（エラー）としてください。

4. 制約および注意点
- 既存機能の継承: 以前に実装した「消費税・送料計算ロジック」および「外部決済ゲートウェイ連携（決済失敗時のロールバック）」が正しく動作し続けるようにしてください。
- 初期データ: 動作確認ができるよう、あらかじめ2〜3の倉庫データと、それらに紐づく初期在庫データを生成（Seed）しておいてください。
```
- **開始時刻**: 13:42:44
- **完了時刻**: 14:18:41
- **実行時間**: 36分

---

<!-- 以下、新しいプロンプトが投げられるたびに追記されます -->